<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vocabulary Review</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="shared.js"></script>
  <style>
    body{max-width:920px;margin:auto;padding:24px;line-height:1.7}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type=number]{width:100px}
    .qa{margin-top:20px;padding:16px;border:1px solid #ddd;border-radius:8px}
    .meta{color:#666;font-size:.9em}
    .ok{color:#0a7}
    .bad{color:#d33}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #bbb;border-radius:999px;font-size:.85em;color:#444}
    button{cursor:pointer}
  </style>
</head>
<body>
  <h1>Vocabulary Review</h1>
  <p class="meta">è³‡æ–™ä¾†æºï¼š<code>vocab.json</code>ï¼ˆå„²å­˜ä½œç­”ç´€éŒ„æ–¼æœ¬æ©Ÿï¼‰</p>

  <div class="row">
    <label>å‡ºé¡Œæ•¸é‡ <input id="count" type="number" min="5" max="100" value="20"/></label>
    <label>
      æ–¹å‘
      <select id="mode">
        <option value="en2zh">è‹± â†’ ä¸­</option>
        <option value="zh2en">ä¸­ â†’ è‹±</option>
      </select>
    </label>
    <label>
      åƒ…ä»Šæ—¥å–®å­—
      <input id="todayOnly" type="checkbox"/>
    </label>
    <button id="start">é–‹å§‹æ¸¬é©—</button>
    <a class="pill" href="check.html" target="_blank">ç ´å¿«å–æª¢æŸ¥</a>
  </div>

  <div id="panel" class="qa" style="display:none">
    <div id="qMeta" class="meta"></div>
    <h2 id="question"></h2>
    <div class="row">
      <input id="answer" type="text" placeholder="è¼¸å…¥ç­”æ¡ˆå¾ŒæŒ‰ Enter"/>
      <button id="speakBtn">ğŸ”ˆ ç™¼éŸ³</button>
      <button id="reveal">çœ‹ç­”æ¡ˆ</button>
      <button id="next">ä¸‹ä¸€é¡Œ</button>
    </div>
    <p id="feedback"></p>
  </div>

  <script>
  // ===== è¨­å®š =====
  const STORAGE_KEY = 'elp_srs_stats_v1';
  const TODAY = new Date();
  const todayDayIndex = (()=>{ // ä»¥ repo ç¾è¡Œ dayN ç‚ºæº–ï¼Œé€™è£¡æš«è¨­ç”±ç¶²å€/æ—¥æœŸæ±ºå®šï¼›ä½ ä¹‹å¾Œå¯æ”¹ç‚ºè®€ index.html çš„ã€Œä»Šæ—¥ã€
    return null; // è‹¥è¦å›ºå®šä»Šå¤©æ˜¯ Day 1 å°±å›å‚³ 1
  })();

  // é€±æœŸè¡°æ¸›ï¼šæ¯æ»¿ 1 é€±ï¼Œweight *= 0.9ï¼ˆä½ è¦çš„ã€Œéš”é€± -10%ã€å†éš”é€± -10%ã€ï¼‰
  function weeklyDecayFactor(lastSeen){
    if(!lastSeen) return 1;
    const weeks = Math.max(0, Math.floor((Date.now() - new Date(lastSeen).getTime()) / (7*24*3600*1000)));
    return Math.pow(0.9, weeks);
  }

  // ç•¶å¤©å–®å­—å¿…å‡ºï¼šçµ¦æœ€å°æ¬Šé‡ä¸‹é™èˆ‡æŠ½é¡Œå„ªå…ˆ
  function dayPriorityBonus(item){
    if (todayDayIndex && item.day === todayDayIndex) return 2.0; // ç•¶æ—¥åŠ å€
    return 1.0;
  }

  // å‹•æ…‹æ¬Šé‡ï¼šç­”éŒ¯å¤šã€ä¹…æ²’å‡ºç¾ã€ç•¶æ—¥å­— â†’ æ¬Šé‡é«˜
  function computeWeight(item){
    const base = item.weight ?? 1.0;
    const seen = item.seen ?? 0;
    const w = (base + (item.wrong||0)*0.6 - (item.correct||0)*0.3);
    const rec = weeklyDecayFactor(item.lastSeen);
    const daily = dayPriorityBonus(item);
    return Math.max(0.05, w * rec * daily);
  }

  // å„²å­˜èˆ‡è¼‰å…¥çµ±è¨ˆ
  function loadStats(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){ return {}; }
  }
  function saveStats(stats){ localStorage.setItem(STORAGE_KEY, JSON.stringify(stats)); }

  // åˆä½µ stats åˆ°é …ç›®
  function mergeStats(items, stats){
    items.forEach(it=>{
      const s = stats[it.id];
      if(s){
        it.seen = s.seen||0; it.correct = s.correct||0; it.wrong = s.wrong||0; it.lastSeen = s.lastSeen||null; it.weight = s.weight ?? 1.0;
      }
    });
  }
  function applyResultToStats(item, ok){
    const stats = loadStats();
    const s = stats[item.id] || {seen:0,correct:0,wrong:0,weight:1.0,lastSeen:null};
    s.seen += 1;
    if(ok){ s.correct += 1; s.weight = Math.max(0.1, s.weight * 0.85); } // ç­”å°é™ä½æ¬Šé‡
    else  { s.wrong  += 1; s.weight = Math.min(5.0,  s.weight + 0.4); }   // ç­”éŒ¯æé«˜æ¬Šé‡
    s.lastSeen = new Date().toISOString();
    stats[item.id] = s;
    saveStats(stats);
  }

  // åŠ æ¬ŠæŠ½æ¨£
  function weightedSample(pool, n){
    const arr = pool.map(it=>({it, w: computeWeight(it)}));
    const res = [];
    for(let k=0;k<n && arr.length>0;k++){
      const sum = arr.reduce((a,b)=>a+b.w,0);
      let r = Math.random()*sum, pickIndex = 0;
      for(let i=0;i<arr.length;i++){
        r -= arr[i].w;
        if(r<=0){ pickIndex = i; break; }
      }
      res.push(arr[pickIndex].it);
      arr.splice(pickIndex,1);
    }
    return res;
  }

  // è¼‰å…¥è³‡æ–™ä¸¦ç¶äº‹ä»¶
  let DATA = [];
  fetch('vocab.json')
    .then(r=>r.json())
    .then(list=>{
      DATA = list;
      mergeStats(DATA, loadStats());
      document.getElementById('start').disabled = false;
    });

  const elPanel = document.getElementById('panel');
  const elQ = document.getElementById('question');
  const elFeedback = document.getElementById('feedback');
  const elMeta = document.getElementById('qMeta');
  const elAns = document.getElementById('answer');
  const elMode = document.getElementById('mode');
  const elCount = document.getElementById('count');
  const elTodayOnly = document.getElementById('todayOnly');

  let quiz = [], idx = 0, mode = 'en2zh';

  function buildQuiz(){
    mode = elMode.value;
    let pool = DATA.slice();

    if (elTodayOnly.checked && todayDayIndex){
      pool = pool.filter(x=>x.day===todayDayIndex);
    }
    // ç¢ºä¿ç•¶æ—¥å–®å­—æœ€ä½æ•¸é‡ï¼ˆè‹¥æœ‰ todayï¼‰
    // å¯è¦–éœ€è¦åœ¨é€™è£¡å†å¼·åˆ¶åŠ å…¥

    const n = Math.min(parseInt(elCount.value||20,10), pool.length);
    quiz = weightedSample(pool, n);
    idx = 0;
  }

  function showOne(){
    const it = quiz[idx];
    elPanel.style.display = 'block';
    elFeedback.textContent = '';
    elAns.value = '';
    elAns.focus();

    if(mode==='en2zh'){
      elQ.textContent = it.word + (it.pos?` (${it.pos})`:'');
      elMeta.textContent = `Day ${it.day} ï½œ KK ${it.kk||''}`;
    }else{
      elQ.textContent = it.zh;
      elMeta.textContent = `Day ${it.day} ï½œ ç›®æ¨™ä½œç­”ï¼š${it.word}`;
    }
  }

  function speakCurrent(){
    const it = quiz[idx];
    const txt = (mode==='en2zh')? it.word : it.word;
    window.speak && window.speak(txt);
  }

  document.getElementById('start').addEventListener('click', ()=>{
    buildQuiz();
    if(quiz.length===0){ alert('ç›®å‰è³‡æ–™ä¸è¶³æˆ–éæ¿¾æ¢ä»¶éåš´ã€‚'); return; }
    showOne();
  });

  function judge(){
    const it = quiz[idx];
    const ans = elAns.value.trim();
    let ok = false, expected='';
    if(mode==='en2zh'){
      expected = it.zh;
      ok = ans === expected;
    }else{
      expected = it.word;
      ok = ans.toLowerCase() === expected.toLowerCase();
    }
    applyResultToStats(it, ok);
    elFeedback.innerHTML = ok
      ? `<span class="ok">âœ… æ­£ç¢ºï¼</span>`
      : `<span class="bad">âŒ éŒ¯èª¤ã€‚</span> æ­£ç¢ºç­”æ¡ˆï¼š<b>${expected}</b>`;
  }

  elAns.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ judge(); }
  });
  document.getElementById('reveal').addEventListener('click', judge);
  document.getElementById('next').addEventListener('click', ()=>{
    if(idx < quiz.length-1){ idx++; showOne(); }
    else { elFeedback.innerHTML = '<b>å®Œæˆæœ¬è¼ªï¼å¯å†æŒ‰ã€Œé–‹å§‹æ¸¬é©—ã€é‡æŠ½ã€‚</b>'; }
  });
  document.getElementById('speakBtn').addEventListener('click', speakCurrent);
  </script>
</body>
</html>
